/*
 *
 * Wijmo Library 1.5.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijbarchart",a.wijmo.wijchartcore,{options:{horizontal:true,stacked:false,is100Percent:false,clusterOverlap:0,clusterWidth:85,clusterRadius:0,clusterSpacing:0,animation:{enabled:true,duration:400,easing:">"},seriesTransition:{enabled:true,duration:400,easing:">"},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_create:function(){var d=["0-#8ac4c0-#77b3af","0-#73a19e-#67908e","0-#4f687b-#465d6e","0-#69475b-#5d3f51","0-#7a3b3f-#682e32","0-#9d5b5b-#8c5151","0-#e5a36d-#ce9262","0-#e6cc70-#ceb664","0-#8ec858-#7fb34f","0-#3a9073-#2a7b5f","0-#6c88e3-#6079cb","0-#6cb4e3-#60a0cb"],b=this,c=b.options;c.horizontal&&a.extend(true,c.axis,{x:{compass:"west"},y:{compass:"south"}});a.extend(true,{compass:"east"},c.hint);a.each(c.seriesStyles,function(b,a){if(!a.fill)a.fill=d[b]});b.bars=[];b.animatedBars=[];b.chartLabels=[];a.wijmo.wijchartcore.prototype._create.apply(b,arguments);b.chartElement.addClass("wijmo-wijbarchart")},_setOption:function(c,b){c==="horizontal"&&!b&&a.extend(true,this.options.axis,{x:{compass:"south"},y:{compass:"west"}});a.wijmo.wijchartcore.prototype._setOption.apply(this,arguments)},destroy:function(){var b=this;b.chartElement.removeClass("wijmo-wijbarchart ui-helper-reset");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);if(b.aniBarsAttr&&b.aniBarsAttr.length){a.each(b.aniBarsAttr,function(b,a){a=null});b.aniBarsAttr=null}},_isBarChart:function(){return true},getBar:function(a){return this.bars[a]},_paint:function(){var c=this,d=c.options,b=d.seriesList,e=false,g,f;if(b.length&&b[0].data&&b[0].data.x&&b[0].data.x.length){g=b[0].data.x[0];if(c._isDate(g))e=true}if(e){c.seriesList=b;f=c._cloneSeriesList(b,d.axis.x.annoFormatString);d.seriesList=f}a.wijmo.wijchartcore.prototype._paint.apply(c,arguments);if(e)d.seriesList=c.seriesList},_cloneSeriesList:function(d,b){var c=[];a.each(d,function(f,e){var d=a.extend(true,{},e);d.data&&d.data.x&&d.data.x.length&&a.each(d.data.x,function(e,c){var a;if(b&&b.length)a=Globalize.format(c,b);else a=c.toString();d.data.x[e]=a});c.push(d)});return c},_clearChartElement:function(){var b=this;if(b.bars&&b.bars.length){a.each(b.bars,function(b,a){if(a.shadow){a.shadow.wijRemove();a.shadow=null}if(a){a.wijRemove();a=null}});b.bars=[]}if(b.animatedBars&&b.animatedBars.length){a.each(b.animatedBars,function(b,a){if(a){a.stop();a.wijRemove();a=null}});b.animatedBars=[]}if(b.chartLabels&&b.chartLabels.length){a.each(b.chartLabels,function(b,a){if(a){a.wijRemove();a=null}});b.chartLabels=[]}a.wijmo.wijchartcore.prototype._clearChartElement.apply(b,arguments)},_adjustToLimits:function(a,c,b){return a<c?c:a>b?b:a},_transformPoints:function(c,d,e,f,g,b){a.each(b,function(j,a){var h=a.x,i=a.y,b=0;a.x=d*h+f;a.y=e*i+g;if(c){b=a.x;a.x=a.y;a.y=b}});return b},_paintPlotArea:function(){var a=this,c=a.options,b=c.horizontal,s=c.stacked,i=[].concat(c.seriesList),j=i.length,p=[].concat(c.seriesStyles.slice(0,j)),o=[].concat(c.seriesHoverStyles.slice(0,j)),h=a.canvasBounds,g={x:h.startX,y:h.startY},n=h.endX-g.x,k=h.endY-g.y,e=c.axis.x,f=c.axis.y,d,l=a._getScaling(b,e.max,e.min,b?k:n),m=a._getScaling(!b,f.max,f.min,b?n:k),q=a._getTranslation(b,g,e.max,e.min,l),r=a._getTranslation(!b,g,f.max,f.min,m);if(b&&!s){i.reverse();p.reverse();o.reverse()}if(j===0)return;d=a._paintClusters(i,p,o,{min:e.min,max:e.max,late:q,scale:l},{min:f.min,max:f.max,late:r,scale:m},n,k,g);a.chartElement.data("plotInfos",{xscale:l,xlate:q,yscale:m,ylate:r,rects:d.rects});a._playAnimation(d.animatedBars);a.bars=d.bars;a.animatedBars=d.animatedBars;a.chartLabels=d.chartLabels},_paintClusters:function(f,w,s,x,y,A,p,u){var b=this,e=b.options,k=e.stacked,d=e.clusterOverlap/100,v=e.clusterWidth/100,m=1,t=e.clusterSpacing+m,n=e.animation,z=n&&n.enabled,j=f.length,c,g,i=[],r=[],l=[],h=[],o=b.axisInfo.y.isTime,q=[];if(o){a.each(f,function(e,d){var c=a.extend(true,{},d);c.data&&c.data.y&&c.data.y.length&&a.each(c.data.y,function(d,a){c.data.y[d]=b._toOADate(a)});q.push(c)});c=b._barPointList(q)}else c=b._barPointList(f);if(k)c=b._stackValues(c);g=b._getMinDX(c)*v;if(j>1&&!k){d-=c.length*(j-1)*t/(e.horizontal?p:A);g/=j*(1-d)+d}a.each(c,function(q,v){var e=v.paSpec,A=e.length,n,t,j,c;if(k)n=g;else n=g*(A*(1-d)+d);t={x:v.x-n/2,y:0,width:g,height:e[0].y};a.each(e,function(g,v){if(!h[g])h[g]=[];var k=v.sIdx,n=w[k];c=b._paintBar(t,v.y,p,x,y,n,z,m,u,d,g>0?e[g-1].y:null,e[e.length-1].y,o,f[k].textStyle);j=c.bar;b._addClass(a(j.node),"wijchart-canvas-object");a(j.node).data("wijchartDataObj",a.extend(true,{index:q,bar:j,type:"bar",style:n,hoverStyle:s[k]},f[k]));r.push(j);c.animatedBar&&l.push(c.animatedBar);c.dcl&&i.push(c.dcl);h[g][q]=c.rect})});a.each(i,function(b,a){a.toFront()});return{bars:r,animatedBars:l,rects:h,chartLabels:i}},_paintBar:function(e,w,O,o,p,l,B,z,N,G,j,y,I,F){var i=this,m=i.options,J=m.stacked,H=m.is100Percent,x=m.horizontal,t=o.min,s=o.max,v=p.min,u=p.max,L=o.scale,M=o.late,C=p.scale,E=p.late,r,b,A,c,n=null,h,D=l,d=l["stroke-width"],K=l.stroke,g,f,k=i.canvas,q=C*m.axis.y.origin+E;if(J)if(H){if(y>0)e.height=w/y;if(j||j===0){e.y=j/y;e.height-=e.y}}else{e.height=w;if(j||j===0){e.height-=j;e.y=j}}else if(j||j===0){e.x+=e.width*(1-G);e.height=w}b=[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y+e.height}];A=(t<=b[0].x&&b[0].x<=s||t<=b[1].x&&b[1].x<=s)&&(v<=b[0].y&&b[0].y<=u||v<=b[1].y&&b[1].y<=u);b[0].x=i._adjustToLimits(b[0].x,t,s);b[0].y=i._adjustToLimits(b[0].y,v,u);b[1].x=i._adjustToLimits(b[1].x,t,s);b[1].y=i._adjustToLimits(b[1].y,v,u);b=i._transformPoints(x,L,C,M,E,b);if(b[0].x>b[1].x){r=b[0].x;b[0].x=b[1].x;b[1].x=r}if(b[0].y>b[1].y){r=b[0].y;b[0].y=b[1].y;b[1].y=r}c={x:b[0].x,y:b[0].y,width:b[1].x-b[0].x,height:b[1].y-b[0].y};if(A){if(c.width===0)c.width=.5;if(c.height===0)c.height=.5}if(m.showChartLabels)n=i._paintDefaultChartLabel(c,w,I,F);h=l.r?l.r:m.clusterRadius;if(h)D=a.extend(true,{},l,{r:0});if(K!=="none"&&d)d=parseInt(d,10);if(!d||isNaN(d))d=0;if(B){if(h){if(x){g=k.wij.roundRect(c.x,c.y,c.width-d,c.height-d,0,0,h,h).hide();f=k.rect(q,c.y,0,c.height-d)}else{g=k.wij.roundRect(c.x,c.y,c.width-d,c.height-d,h,0,0,h).hide();f=k.rect(c.x,q,c.width,0)}i._paintShadow(f,z);f.wijAttr(D);f.bar=g}else{if(x)g=k.rect(q,c.y,0,c.height-d);else g=k.rect(c.x,q,c.width,0);f=g}if(n){n.attr({opacity:0});f.chartLabel=n}f.left=c.x;f.top=c.y;f.width=c.width-d;f.height=c.height-d;f.r=h}else if(h)g=k.wij.roundRect(c.x,c.y,c.width-d,c.height-d,0,0,h,h);else g=k.rect(c.x,c.y,c.width-d,c.height-d);i._paintShadow(g,z);B&&h&&g.shadow.hide();g.wijAttr(l);return{rect:c,dcl:n,animatedBar:f,bar:g}},_playAnimation:function(j){var b=this,e=b.options,d=e.animation,f=e.seriesTransition,g,h,i=[],c;if(d&&d.enabled){g=d.duration||2e3;h=d.easing||"linear";a.each(j,function(j,d){var k=e.horizontal?{width:d.width,x:d.left}:{height:d.height,y:d.top};if(b.aniBarsAttr&&f.enabled){c=b._getDiffAttrs(b.aniBarsAttr[j],d.attr());if(e.horizontal){c.left=b.aniBarsAttr[j].left;c.width=b.aniBarsAttr[j].width}else{c.top=b.aniBarsAttr[j].top;c.height=b.aniBarsAttr[j].height}if(c.path)delete c.path;d.attr(c);g=f.duration;h=f.easing}i.push(a.extend(true,{},d.attr(),k));d.stop().wijAnimate(k,g,h,function(){var a=this,c=a.r,b=a;a.chartLabel&&a.chartLabel.wijAnimate({opacity:1},250);if(c){b=a.bar;b.show();b.shadow&&b.shadow.show();if(a.shadow){a.shadow.wijRemove();a.shadow=null}a.wijRemove();a=null}})});b.aniBarsAttr=i}},_paintDefaultChartLabel:function(b,l,m,j){var f=this,c=f.options,k=c.horizontal,h=a.extend(true,{},c.textStyle,c.chartLabelStyle),g=k?{x:b.x+b.width,y:b.y+b.height/2}:{x:b.x+b.width/2,y:b.y},i,d,e;if(j)h=a.extend(true,h,j);if(m)e=f._fromOADate(l);else e=f.round(l,2);if(c.chartLabelFormatString&&c.chartLabelFormatString.length)e=Globalize.format(e,c.chartLabelFormatString);d=f._text(g.x,g.y,e).attr(h);i=d.getBBox();if(k)d.attr({x:g.x+i.width/2});else d.attr({y:g.y-i.height/2});return d},_getChartLabelPointPosition:function(k){var a=this,n=k.attachMethod,e=k.attachMethodData,g={x:0,y:0},b,f,i,c,d,j,m,h,l;switch(n){case"coordinate":g.x=e.x;g.y=e.y;break;case"dataCoordinate":b=a.chartElement.data("plotInfos");c=e.x;d=e.y;if(a._isDate(c))c=a._toOADate(c);if(a._isDate(d))d=a._toOADate(d);g=a._transformPoints(b.xscale,b.yscale,b.xlate,b.ylate,{x:c,y:d});break;case"dataIndex":f=e.seriesIndex;i=e.pointIndex;b=a.chartElement.data("plotInfos");if(f>-1){j=b.rects;if(j.length>f){m=j[f];h=m[i];g.x=h.x+h.width;g.y=h.y+h.height/2}}break;case"dataIndexY":f=e.seriesIndex;i=e.pointIndex;if(f>-1){l=a.options.seriesList[f].data;c=l.x[i];d=e.y;b=a.chartElement.data("plotInfos");if(a._isDate(c))c=a._toOADate(c);if(a._isDate(d))d=a._toOADate(d);g=a._transformPoints(b.xscale,b.yscale,b.xlate,b.ylate,{x:c,y:d})}}return g},_getTooltipText:function(h,g){var d=a(g.node).data("wijchartDataObj"),c=d.index,b=d.data,e,f,i;if(b.x){e=b.x[c];f=b.y[c]}else{e=b.xy[2*c];f=b.xy[2*c+1]}i={x:e,y:f,data:d,target:g,fmt:h};return a.proxy(h,i)()},_bindLiveEvents:function(){var b=this,d=b.options,h=d.hint.enable,e=b.tooltip,c,g,f;if(h&&!e){c=a.extend(true,{},d.hint);c.offsetY=c.offsetY||-2;g=c.title;f=c.content;if(a.isFunction(g))c.title=function(){return b._getTooltipText(g,this.target)};if(a.isFunction(f))c.content=function(){return b._getTooltipText(f,this.target)};c.beforeShowing=function(){if(this.target)this.options.style.stroke=this.target.attrs.stroke||this.target.attrs.fill};e=b.canvas.tooltip(b.bars,c);b.tooltip=e}a(".wijchart-canvas-object",b.chartElement[0]).live("mousedown.wijbarchart",function(c){if(d.disabled)return;b._trigger("mouseDown",c,a(c.target).data("wijchartDataObj"))}).live("mouseup.wijbarchart",function(c){if(d.disabled)return;b._trigger("mouseUp",c,a(c.target).data("wijchartDataObj"))}).live("mouseover.wijbarchart",function(c){if(d.disabled)return;b._trigger("mouseOver",c,a(c.target).data("wijchartDataObj"))}).live("mouseout.wijbarchart",function(g){if(d.disabled)return;var c=a(g.target).data("wijchartDataObj"),f=c.bar;b._trigger("mouseOut",g,c);if(!c.hoverStyle)f&&f.attr({opacity:"1"});else f.attr(c.style);e&&e.hide()}).live("mousemove.wijbarchart",function(f){if(d.disabled)return;var c=a(f.target).data("wijchartDataObj"),e=c.bar;b._trigger("mouseMove",f,c);if(!c.hoverStyle)e&&e.attr({opacity:"0.8"});else e.attr(c.hoverStyle)}).live("click.wijbarchart",function(c){if(d.disabled)return;b._trigger("click",c,a(c.target).data("wijchartDataObj"))})},_unbindLiveEvents:function(){var b=this;a(".wijchart-canvas-object",b.chartElement[0]).die("wijbarchart");if(b.tooltip){b.tooltip.destroy();b.tooltip=null}},_calculateParameters:function(c,e){a.wijmo.wijchartcore.prototype._calculateParameters.apply(this,arguments);if(c.id==="x"){var d=e.unitMinor,b=this._getBarAdjustment(c);if(b===0)b=d;else if(d<b&&d!==0)b=Math.floor(b/d)*d;c.min-=b;c.max+=b;this._calculateMajorMinor(e,c)}},_getBarAdjustment:function(c){for(var a=0,h=this.options,e=c.max,b=c.min,g=h.seriesList,f=0,d=0,f=0;f<g.length;f++){d=g[f].data.x.length;if(a<d)a=d}if(a>1)return(e-b)/a*h.clusterWidth*.0125;else if(a===1){if(b===0&&e===1){b=-1;c.min=b}return(e-b)*.0125}else return 0}});a.extend(a.wijmo.wijbarchart.prototype,{_barPointList:function(f){var b=[],d=this._getXSortedPoints;function c(b){this.x=b;this.paSpec=[];this.stackValues=function(){var c=this.paSpec.length,b;if(c>1){b=this.paSpec[0];a.each(this.paSpec,function(c,a){if(c===0)return true;a.y+=b.y;b=a})}}}function e(n,m){var h=d(m),l=m.length,f=null,o=0,e=0,g=0,k=true,i=0,j=false;if(h)o=h.length;if(b)g=b.length;a.each(h,function(d,a){if(k){k=false;i=a.x}else{if(i===a.x)j=true;else j=false;i=a.x}while(e<g&&b[e].x<a.x)e++;if(e<g)if(b[e].x!==a.x){f=new c(a.x,l);b.splice(e,0,f);g=b.length}else f=b[e];else{f=new c(a.x,l);b.push(f);g=b.length}f.paSpec.push({y:a.y,sIdx:n,pIdx:d,dupl:j})})}a.each(f,function(b,a){e(b,a)});return b},_getSpecWithValue:function(b){var c=null;a.each(b,function(d,a){if(a.x>=b){if(a.x===b)c=a;return false}});return c},_getMinDX:function(d){for(var a=Number.MAX_VALUE,e=d.length,c,b=1;b<e;b++){c=d[b].x-d[b-1].x;if(c<a&&c>0)a=c}return a===Number.MAX_VALUE?2:a},_stackValues:function(b){a.each(b,function(b,a){a.stackValues()});return b}})})(jQuery);