/*
 *
 * Wijmo Library 2.1.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijdatepager",{options:{culture:"",firstDayOfWeek:0,selectedDate:new Date,viewType:"day"},_setOption:function(c,b){a.Widget.prototype._setOption.apply(this,arguments);switch(c){case"selectedDate":this.options.selectedDate=b;this._initBackground();break;case"disabled":if(b)this._disable();else this._enable();break;case"viewType":this.options.viewType=b;this._initBackground()}return this},_disable:function(){this.element.addClass("ui-state-disabled");this.element.find(".wijmo-wijdatepager-decrement").button("option","disabled",true);this.element.find(".wijmo-wijdatepager-increment").button("option","disabled",true)},_enable:function(){this.element.removeClass("ui-state-disabled");this.element.find(".wijmo-wijdatepager-decrement").button("option","disabled",false);this.element.find(".wijmo-wijdatepager-increment").button("option","disabled",false)},_create:function(){var b=this.options,c;if(!b.selectedDate)b.selectedDate=new Date;this._dtpagernamespacekey="dtpager"+ +new Date;this.element.addClass("wijmo-wijdatepager ui-widget ui-helper-clearfix");c=a.proxy(this.invalidate,this);a(window).bind("resize."+this._dtpagernamespacekey,c);this.element.disableSelection();this.element.append(a('<a class="wijmo-wijdatepager-decrement"><span>left</span></a>')).append('<div class="wijmo-wijdatepager-container ui-widget-content"><div class="wijmo-wijdatepager-pages"></div></div><a class="wijmo-wijdatepager-increment"><span>right</span></a>');a.Widget.prototype._create.apply(this,arguments);this.element.find(".wijmo-wijdatepager-decrement").button({icons:{primary:"ui-icon-triangle-1-w"},text:false}).click(a.proxy(this.goLeft,this));this.element.find(".wijmo-wijdatepager-increment").button({icons:{primary:"ui-icon-triangle-1-e"},text:false}).click(a.proxy(this.goRight,this));this._initBackground();b.disabled&&this._disable()},destroy:function(){this.element.removeClass("wijmo-wijdatepager");a(window).unbind("."+this._dtpagernamespacekey)},refresh:function(){this.invalidate()},invalidate:function(){var g=a(this.element.find(".wijmo-wijdatepager-pagelabel")[this._index]),c=this.element.find(".wijmo-wijdatepager-container"),e=this.element.find(".wijmo-wijdatepager-decrement"),f=this.element.find(".wijmo-wijdatepager-increment"),b=this.element.innerWidth(),d=e.is(":visible")?e.outerWidth(true):0,h=f.is(":visible")?f.outerWidth(true):0;this.element.find(".wijmo-wijdatepager-pagelabel.ui-state-active").removeClass("ui-state-active");g.addClass("ui-state-active");c.css("left",d);this.element.removeClass("wijmo-wijdatepager-width-smallest wijmo-wijdatepager-width-small wijmo-wijdatepager-width-medium wijmo-wijdatepager-width-normal");if(b<300)this.element.addClass("wijmo-wijdatepager-width-smallest");else if(b<475)this.element.addClass("wijmo-wijdatepager-width-small");else if(b<600)this.element.addClass("wijmo-wijdatepager-width-medium");else this.element.addClass("wijmo-wijdatepager-width-normal");c.outerWidth(b-d-h)},goLeft:function(){var a=this.options;if(a.disabled)return;this._setSelectedIndex(this._index-1,true)},goRight:function(){var a=this.options;if(a.disabled)return;this._setSelectedIndex(this._index+1)},_getCulture:function(a){return Globalize.findClosestCulture(a||this.options.culture)},_isRTL:function(){return!!this._getCulture().isRTL},_initBackground:function(j,i){var f,d,c,b,g,h,e=this;if(this._isInAnimate)return;this._index=0;this._datesDef=this._getDatesDefinition();this._min=0;this._max=this._datesDef.length-1;f="";for(d=0;d<this._datesDef.length;d+=1)f+='<div class="wijmo-wijdatepager-pagelabel'+(d===0?" wijmo-wijdatepager-pagelabel-first":"")+(this._datesDef[d].range?" wijmo-wijdatepager-pagerange":"")+(this._datesDef[d].header?" wijmo-wijdatepager-pageheader ui-state-highlight":"")+(d===this._datesDef.length-1?" wijmo-wijdatepager-pagelabel-last":"")+'">'+this._datesDef[d].l+"</div>";b=this.element.find(".wijmo-wijdatepager-pages");if(j){this._isInAnimate=true;c=b.clone(true);b.html(f);g=b.find(".wijmo-wijdatepager-pagelabel");if(!i){c.insertBefore(b);h=a(g[this._index]).offset().left;b.css("opacity",0).css("left",c.outerWidth(true)).stop().animate({left:"0px",opacity:100});c.stop().animate({left:"-"+c.outerWidth(true)+"px",opacity:0},function(){c.remove();e._isInAnimate=false;e.invalidate()})}else{c.insertAfter(b);h=a(g[this._index]).offset().left;b.css("opacity",0).css("left",-c.outerWidth(true)).stop().animate({left:"0px",opacity:100});c.css("left",0).stop().animate({left:c.outerWidth(true)+"px",opacity:0},function(){c.remove();e._isInAnimate=false;e.invalidate()})}}else{b.html(f);this.invalidate()}b.find(".wijmo-wijdatepager-pagelabel").hover(a.proxy(this._pagelabelHover,this),a.proxy(this._pagelabelHout,this));b.find(".wijmo-wijdatepager-pagelabel").bind("mousedown",a.proxy(this._pagelabelMouseDown,this));b.find(".wijmo-wijdatepager-pagelabel").click(a.proxy(function(d){var c=a(d.target),b;b=this.element.find(".wijmo-wijdatepager-pagelabel").index(c);this._setSelectedIndex(b)},this))},_addDays:function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate()+b)},_getDatesDefinition:function(){var g=this.options,i=g.viewType.toLowerCase(),d,c,a,f,h,e=[],b=g.selectedDate;switch(i){case"week":a=new Date(b.getFullYear(),b.getMonth(),-6);d=g.firstDayOfWeek-a.getDay();if(Math.abs(d)>6)d=a.getDay()-g.firstDayOfWeek;a=this._addDays(a,d);h=new Date(b.getFullYear(),b.getMonth()+1,7);d=0;while(a<h||a.getMonth()===b.getMonth()){f=this._addDays(a,7);e.push({l:Globalize.format(a,"MMM",this._getCulture())+" "+Globalize.format(a,"dd",this._getCulture())+"-"+Globalize.format(this._addDays(a,6),"dd",this._getCulture()),d:a,d2:this._addDays(a,6)});if(b>=a&&b<=f)this._index=d;a=f;d+=1}break;case"month":c=new Date(b.getFullYear()-1,0,1);e.push({l:c.getFullYear(),d:c,range:true});c=new Date(b.getFullYear(),0,1);e.push({l:c.getFullYear(),d:c,header:true});for(d=0;d<12;d+=1){c=new Date(b.getFullYear(),d,1);e.push({l:Globalize.format(c,"MMM",this._getCulture()),d:c});f=new Date(b.getFullYear(),d+1,1);if(b>=c&&b<=f)this._index=d+2}c=new Date(b.getFullYear()+1,0,1);e.push({l:c.getFullYear(),d:c,range:true});break;default:c=new Date(b.getFullYear(),b.getMonth(),0);e.push({l:Globalize.format(c,"MMM",this._getCulture()),d:c,range:true});c=new Date(b.getFullYear(),b.getMonth(),1);e.push({l:Globalize.format(c,"MMM",this._getCulture()),d:c,header:true});a=c;d=2;while(a.getMonth()===b.getMonth()){f=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1);e.push({l:Globalize.format(a,"d ",this._getCulture()),d:a});if(b>=a&&b<=f)this._index=d;a=f;d+=1}c=new Date(b.getFullYear(),b.getMonth()+1,1);e.push({l:Globalize.format(c,"MMM",this._getCulture()),d:c,range:true})}return e},_setSelectedIndex:function(a,c){var b=this.options;if(b.disabled)return;if(a>=this._min&&a<=this._max){this._dragActivated&&this._showTooltip(a);if(this._index!==a){if(this._datesDef[a].header)if(c)a=a-1;else return;this._index=a;b.selectedDate=this._datesDef[a].d;if(this._index===this._max)if(b.viewType==="week")b.selectedDate=new Date(b.selectedDate.getFullYear(),b.selectedDate.getMonth(),b.selectedDate.getDate()+7);if(this._max>2&&this._index===0)this._initBackground(true,true);else if(this._index===this._max)this._initBackground(true,false);else this.invalidate();this._trigger("selectedDateChanged",null,{selectedDate:b.selectedDate})}}},_pagelabelHover:function(c){var b=a(c.target);if(b.hasClass("wijmo-wijdatepager-pageheader"))return;b.addClass("ui-state-hover")},_showTooltip:function(d){var g=this.options,b=this._datesDef[d],e=g.viewType,c,f=this.element.find(".wijmo-wijdatepager-pagelabel")[d];if(!this._tooltip){this._tooltip=a('<div class="wijmo-wijdatepager-tooltip"><div class="wijmo-wijdatepager-tooltip-inner"></div><div class="wijmo-wijdatepager-triangle"></div></div>');this.element.append(this._tooltip);this._tooltip.wijpopup()}c="";switch(e){case"day":c=Globalize.format(b.d,"dddd, MMMM d, yyyy",this._getCulture());break;case"week":c=Globalize.format(b.d,"MMMM d - ",this._getCulture())+Globalize.format(b.d2,b.d.getMonth()!==b.d2.getMonth()?"MMMM d, yyyy":"d, yyyy",this._getCulture());break;case"month":c=Globalize.format(b.d,"MMMM yyyy",this._getCulture())}this._tooltip.wijpopup("show",{of:f,my:"center bottom",at:"center top",offset:"-10 -10"});this._tooltip.find(".wijmo-wijdatepager-tooltip-inner").html(c)},_hideTooltip:function(){this._tooltip.wijpopup("hide")},_pagelabelHout:function(b){a(b.target).removeClass("ui-state-hover")},_pagelabelMouseDown:function(c){this._dragActivated=false;if(this.options.disabled)return;c.preventDefault();var d=a(c.target),b;if(d.hasClass("wijmo-wijdatepager-pageheader"))return;b=this.element.find(".wijmo-wijdatepager-pagelabel").index(d);this._dragActivated=true;this._setSelectedIndex(b);this._mouseDownTimeFix20555=+new Date;this._startClientX=c.pageX;this._startInd=b;a(document).bind("mousemove."+this._dtpagernamespacekey,a.proxy(this._pageindicatorMouseMove,this));a(document).bind("mouseup."+this._dtpagernamespacekey,a.proxy(this._pageindicatorMouseUp,this))},_pageindicatorMouseMove:function(d){d.preventDefault();if(this._isInAnimate)return;var b=this.element.find(".wijmo-wijdatepager-pagelabel")[this._startInd],c,a;if(!b)return;c=b.offsetLeft+Math.round(b.offsetWidth/2)+(d.pageX-this._startClientX);a=this._findClosesPageIndexByPos(c);if(this._prevMoveInd===a)return;this._prevMoveInd=a;if(this._mouseDownTimeFix20555+150>+new Date)return;a!==-1&&a!==this._index&&this._setSelectedIndex(a)},_pageindicatorMouseUp:function(){this._dragActivated=false;a(document).unbind("."+this._dtpagernamespacekey);this._hideTooltip()},_findClosesPageIndexByPos:function(c){for(var b=this.element.find(".wijmo-wijdatepager-pages").find(".wijmo-wijdatepager-pagelabel"),a=0;a<b.length;a+=1)if(b[a].offsetLeft<c&&b[a].offsetLeft+b[a].offsetWidth>c)return a;return-1}})})(jQuery);