/*
 *
 * Wijmo Library 1.5.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";var o="wijmo-wijupload",g="wijmo-wijupload-fileRow",b="."+g,r="wijmo-wijupload-filesList",q="wijmo-wijupload-commandRow",f="wijmo-wijupload-uploadAll",e="wijmo-wijupload-cancelAll",p="wijmo-wijupload-buttonContainer",j="wijmo-wijupload-upload",c="."+j,i="wijmo-wijupload-cancel",k="."+i,s="wijmo-wijupload-file",d="wijmo-wijupload-progress",h="wijmo-wijupload-loading",t="ui-widget-content",l="ui-corner-all",u="ui-state-highlight",n,m;n=function(l,g,h){var f,c=a("input",g),b=new XMLHttpRequest,d=function(a){if(a.indexOf("\\")>-1)a=a.substring(a.lastIndexOf("\\")+1);return a},k=function(a,b){var c=d(b.val());a.open("POST",h,true);a.setRequestHeader("Wijmo-RequestType","XMLHttpRequest");a.setRequestHeader("Cache-Control","no-cache");a.setRequestHeader("Wijmo-FileName",c);a.setRequestHeader("Content-Type","application/octet-stream");a.send(b.get(0).files[0])},j=function(a){if(a){a.abort();a=null}},i=function(a){if(a)a=null},e;e=function(){var e=this;e.fileRow=g;e.xhr=b;e.inputFile=c;e.upload=function(){k(b,c)};e.cancel=function(){j(b);a.isFunction(e.onCancel)&&e.onCancel()};e.destroy=function(){i(b)};e.updateAction=function(a){h=a};e.onCancel=null;e.onComplete=null;e.onProgress=null;b.upload.onprogress=function(b){if(b.lengthComputable){var f;if(a.isFunction(e.onProgress)){f={supportProgress:true,loaded:b.loaded,total:b.total,fileName:d(c.val())};e.onProgress(f)}}};b.onreadystatechange=function(f){if(b.readyState===4){var d=b.responseText,c;if(a.isFunction(e.onComplete)){c={e:f,response:d,supportProgress:true};e.onComplete(c)}}}};f=new e;return f};m=function(n,j,l){var i,d=a("input",j),m=d.attr("id"),e="wijUploadForm_"+n,b=a("#"+e),g="wijUploadIfm_"+m,f=true,c=a('<iframe id="'+g+'" name="'+g+'">'),k=function(c,a){b.empty();b.attr("target",c.attr("name"));if(a){a.parent().append(a.clone());b.append(a)}b.submit()},p=function(a){a.attr("src","javascript".concat(":false;"))},o=function(a,c){if(c&&b){b.remove();b=null}if(a){a.remove();a=null}},h;if(b.length===0){b=a('<form method="post" enctype="multipart/form-data"></form>');b.attr("action",l).attr("id",e).attr("name",e).appendTo("body")}c.css("position","absolute").css("top","-1000px").css("left","-1000px");c.appendTo("body");h=function(){var e=this;e.fileRow=j;e.iframe=c;e.inputFile=d;e.upload=function(){var b;k(c,d);if(a.isFunction(e.onProgress)){b={supportProgress:false,loaded:1,total:1};e.onProgress(b)}};e.doPost=function(){k(c)};e.cancel=function(){p(c);a.isFunction(e.onCancel)&&e.onCancel()};e.updateAction=function(a){l=a;b.attr("action",a)};e.destroy=function(a){o(c,a)};e.onCancel=null;e.onComplete=null;e.onProgress=null;c.bind("load",function(i){if(!a.browser.safari)if(f){f=false;return}if(c.attr("src")==="javascript".concat(":false;"))return;var g=i.target,d,b,h;try{b=g.contentDocument?g.contentDocument:window.frames[0].document;if(b.XMLDocument)d=b.XMLDocument;else if(b.body)d=b.body.innerHTML;else d=b;if(a.isFunction(e.onComplete)){h={e:i,response:d,supportProgress:false};e.onComplete(h)}}catch(j){d=""}})};i=new h;return i};a.widget("wijmo.wijupload",{options:{action:"",autoSubmit:false,change:null,upload:null,totalUpload:null,progress:null,totalProgress:null,complete:null,totalComplete:null},_create:function(){var a=this,d=a.options,c=+new Date,b=a.supportXhr();a.filesLen=0;a.totalUploadFiles=0;a.useXhr=b;a.id=c;a.element.addClass(o);a._createContainers();a._createUploadButton();a._createFileInput();a._bindEvents();d.disabled&&a.disable()},_setOption:function(d,c){var b=this;a.Widget.prototype._setOption.apply(this,arguments);d==="disabled"&&b._handleDisabledOption(c,b.element)},_handleDisabledOption:function(b,c){var a=this;if(b){if(!a.disabledDiv)a.disabledDiv=a._createDisabledDiv(c);a.disabledDiv.appendTo("body")}else if(a.disabledDiv){a.disabledDiv.remove();a.disabledDiv=null}},_createDisabledDiv:function(d){var g=this,b=d?d:g.element,c=b.offset(),f=b.outerWidth(),e=b.outerHeight();return a("<div></div>").addClass("ui-disabled").css({"z-index":"99999",position:"absolute",width:f,height:e,left:c.left,top:c.top})},destroy:function(){var b=this;b.element.removeClass(o);b.element.undelegate(b.widgetName);b.input.remove();b.addBtn.remove();b.filesList.remove();b.commandRow.remove();if(b.uploaders){a.each(b.uploaders,function(b,a){a.destroy&&a.destroy(true);a=null});b.uploaders=null}if(b.disabledDiv){b.disabledDiv.remove();b.disabledDiv=null}},supportXhr:function(){var a=false;if(typeof(new XMLHttpRequest).upload==="undefined")a=false;else a=true;return a},_createContainers:function(){var b=this,d=a("<ul>").addClass(r).appendTo(b.element),c=a("<div>").addClass(q).appendTo(b.element);b.filesList=d;c.hide();b.commandRow=c;b._createCommandRow(c)},_createCommandRow:function(d){var c=a("<a>").attr("href","#").text("uploadAll").addClass(f).button({icons:{primary:"ui-icon-circle-arrow-n"},label:"Upload All"}),b=a("<a>").attr("href","#").text("cancelAll").addClass(e).button({icons:{primary:"ui-icon-cancel"},label:"Cancel All"});d.append(c).append(b)},_createUploadButton:function(){var b=this,c=a("<a>").attr("href","#").button({label:"Upload files"});c.mousemove(function(a){if(b.input){var c=a.pageX,d=a.pageY;b.input.offset({left:c+10-b.input.width(),top:d+10-b.input.height()})}});b.addBtn=c;b.element.prepend(c)},_createFileInput:function(){var b=this,e=b.addBtn,f=e.offset(),g="wijUpload_"+b.id+"_input"+b.filesLen,d=a("<input>").attr("type","file").prependTo(b.element);b.filesLen++;d.attr("id",g).attr("name",g).css("position","absolute").offset({left:f.left+e.width()-d.width(),top:f.top}).css("z-index","9999").css("opacity",0).height(e.height()).css("cursor","pointer");b.input=d;d.bind("change",function(g){var f,e;if(b._trigger("change",g,a(this))===false)return false;b._createFileInput();f=b._createFileRow(a(this));if(b.options.autoSubmit){e=a(c,f);e&&e.click()}d.unbind("change")});b.uploadAll=false},_createFileRow:function(h){var e=this,c=a("<li>"),r=h.val(),n,m,k,f=a("<span>").addClass(p),q=a("<a>").attr("href","#").text("upload").addClass(j).button({text:false,icons:{primary:"ui-icon-circle-arrow-n"},label:"upload"}),o=a("<a>").attr("href","#").text("cancel").addClass(i).button({text:false,icons:{primary:"ui-icon-cancel"},label:"cancel"});c.addClass(g).addClass(t).addClass(l);c.append(h);h.hide();n=a("<span>"+e._getFileName(r)+"</span>").addClass(s).addClass(u).addClass(l);c.append(n);c.append(f);m=a("<span />").addClass(d);f.append(m);f.append(q).append(o);c.appendTo(e.filesList);k=a(b,e.element);if(k.length){e.commandRow.show();e._createUploader(c);e._resetProgressAll()}return c},_createUploader:function(e){var b=this,g=a("input",e),f=b.options.action,c;if(b.useXhr)c=n(b.id,e,f);else c=m(b.id,e,f);c.onCancel=function(){var a=this,c=b.uploaders[a.inputFile.attr("id")];b._trigger("cancel",null,a.inputFile);b.totalUploadFiles--;b.totalUploadFiles===0&&b.uploadAll&&b._trigger("totalComplete")};if(b._wijUpload()){c.onProgress=function(c){var e=a("."+d,this.fileRow);if(c.supportProgress){e.html(Math.round(1e3*c.loaded/c.total)/10+"%");b._trigger("progress",null,{sender:c.fileName,loaded:c.loaded,total:c.total});b._progressTotal(c.fileName,c.loaded)}else e.addClass(h)};c.onComplete=function(f){var c=this,j=b.uploaders[c.inputFile.attr("id")],g=b._getFileName(c.inputFile.val()),i=b._getFileSize(c.inputFile[0]),e=a("."+d,c.fileRow);b._trigger("complete",f.e,c.inputFile);e.removeClass(h);e.html("100%");b._removeFileRow(c.fileRow,j);b._progressTotal(g,i);b.totalUploadFiles--;b.totalUploadFiles===0&&b.uploadAll&&b._trigger("totalComplete",f.e)}}if(typeof b.uploaders==="undefined")b.uploaders={};b.uploaders[g.attr("id")]=c},_progressTotal:function(f,e){var b=this,a=b.progressAll,c,d;if(!b.uploadAll)return;if(a&&a.loadedSize){a.loadedSize[f]=e;c=b._getLoadedSize(a.loadedSize);d=a.totalSize}b._trigger("totalProgress",null,{loaded:c,total:d})},_getLoadedSize:function(c){var b=0;a.each(c,function(c,a){b+=a});return b},_getTotalSize:function(){var b=this,c=0;b.uploaders&&a.each(b.uploaders,function(d,a){c+=b._getFileSize(a.inputFile[0])});return c},_resetProgressAll:function(){this.progressAll={totalSize:0,loadedSize:{}}},_wijUpload:function(){return true},_wijcancel:function(){},_upload:function(){},_bindEvents:function(){var d=this,g=d.progressAll;d.element.delegate(k,"click."+d.widgetName,function(){var h=a(this),f=h.parents(b),c=a("input",f[0]),e=d.uploaders[c.attr("id")];d._wijcancel(c);d._wijUpload()&&e&&e.cancel();if(g){g.totalSize-=d._getFileSize(c[0]);if(g.loadedSize[c.val()])delete g.loadedSize[c.val()]}d._removeFileRow(f,e)});d.element.delegate(c,"click."+d.widgetName,function(h){var g=a(this),f=g.parents(b),c=a("input",f[0]),e=d.uploaders[c.attr("id")];if(d._trigger("upload",h,c)===false)return false;d.totalUploadFiles++;d._upload(f);e&&d._wijUpload()&&e.upload()});d.element.delegate("."+f,"click."+d.widgetName,function(b){d.uploadAll=true;!d.progressAll&&d._resetProgressAll();if(d._trigger("totalUpload",b,null)===false)return false;d.progressAll.totalSize=d._getTotalSize();d._wijuploadAll(a(c,d.filesList[0]));d._wijUpload()&&a(c,d.filesList[0]).each(function(c,b){a(b).click()})});d.element.delegate("."+e,"click."+d.widgetName,function(){d._resetProgressAll();a(k,d.filesList[0]).each(function(c,b){a(b).click()})})},_wijuploadAll:function(){},_wijFileRowRemoved:function(){},_removeFileRow:function(f,c){var d=this,e,g;if(c)e=c.inputFile.attr("id");f.fadeOut(1500,function(){f.remove();d._wijFileRowRemoved(f);if(d.uploaders[e])delete d.uploaders[e];g=a(b,d.element);if(g.length){d.commandRow.show();c&&c.destroy&&c.destroy()}else{d.commandRow.hide();d._resetProgressAll();c&&c.destroy&&c.destroy(true)}})},_getFileName:function(a){if(a.indexOf("\\")>-1)a=a.substring(a.lastIndexOf("\\")+1);return a},_getFileSize:function(a){if(a.files&&a.files.length>0){var b=a.files[0];if(b.size)return b.size}return 0}})})(jQuery);