/*
 *
 * Wijmo Library 2.1.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijpiechart",a.wijmo.wijchartcore,{options:{radius:null,innerRadius:0,animation:{enabled:true,duration:400,easing:">",offset:10},seriesTransition:{enabled:true,duration:1e3,easing:"bounce"},seriesList:[],mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_create:function(){var b=this,c=b._getDefFill();a.wijmo.wijchartcore.prototype._create.apply(b,arguments);b.chartElement.addClass("wijmo-wijpiechart");a.each(this.options.seriesStyles,function(b,a){if(!a.fill)a.fill=c[b]})},destroy:function(){var f=this,e=f.chartElement,b=e.data("fields"),c=b&&b.sectors,d=b&&b.labels;e.removeClass("wijmo-wijpiechart");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);c&&c.length&&a.each(c,function(b,a){a=null});d&&d.length&&a.each(d,function(b,a){a=null});e.data("fields",null)},_isPieChart:function(){return true},getSector:function(b){var a=this.chartElement.data("fields");return a&&a.chartElements?a.chartElements.sectors[b]:null},_bindData:function(){var f=this,h=f.options,g=h.dataSource,e=h.data,i=[],c,d,b;if(g&&e){c=e.label;d=e.value;b=e.offset;if(c&&c.bind)c=f._getBindData(g,c.bind);if(d&&d.bind)d=f._getBindData(g,d.bind);if(b&&b.bind)b=f._getBindData(g,b.bind);if(c&&a.isArray(c)&&c.length&&d&&a.isArray(d)&&d.length){a.each(d,function(e,h){var g,f=0;if(e>=0&&e<c.length)g=c[e];if(b&&a.isArray(d)&&b.length&&e>=0&&e<b.length)f=typeof b[e]==="undefined"?0:b[e];i.push({data:h,label:g,offset:f,legendEntry:true})});h.seriesList=i}}},_getSeriesFromTR:function(i,e,h){var d=null,g=null,b=null,f=null,c=null;e.length&&e.each(function(){g=a("th",a(this));d=a.trim(g.text());b=a("td",a(this));if(b.length)f=parseFloat(a.trim(a(b[0]).text()));c={label:d,legendEntry:true,data:f};h.push(c)})},_showSerieEles:function(a){var b=this.options.showChartLabels;if(a.sector){a.sector.show();a.sector.shadow&&a.sector.shadow.show();a.sector.tracker&&a.sector.tracker.show()}a.label&&b&&a.label.show()},_hideSerieEles:function(a){if(a.sector){a.sector.hide();a.sector.shadow&&a.sector.shadow.hide();a.sector.tracker&&a.sector.tracker.hide()}a.label&&a.label.hide()},_hasAxes:function(){return false},_mouseDown:function(){a.wijmo.wijchartcore.prototype._mouseDown.apply(this,arguments)},_mouseUp:function(){a.wijmo.wijchartcore.prototype._mouseUp.apply(this,arguments)},_mouseOver:function(){a.wijmo.wijchartcore.prototype._mouseOver.apply(this,arguments)},_mouseOut:function(){a.wijmo.wijchartcore.prototype._mouseOut.apply(this,arguments)},_mouseMove:function(){a.wijmo.wijchartcore.prototype._mouseMove.apply(this,arguments)},_click:function(){a.wijmo.wijchartcore.prototype._click.apply(this,arguments)},_paintTooltip:function(){var c=this,d=c.chartElement,b=d.data("fields");a.wijmo.wijchartcore.prototype._paintTooltip.apply(this,arguments);if(c.tooltip&&b)if(b.trackers&&b.trackers.length){c.tooltip.setSelector(a(".wijchart-canvas-object",d[0]));c.tooltip.setOptions({relatedElement:b.trackers[0]})}},_paintPlotArea:function(){var b=this,c=b.options,d=b.canvasBounds,g=d.endX-d.startX,f=d.endY-d.startY,e=c.radius;if(!e)e=Math.min(g,f)/2;else{if(g<2*e)e=g/2;if(f<2*e)e=f/2}d.startX+=g/2-e;d.endX=d.startX+2*e;d.startY+=f/2-e;d.endY=d.startY+2*e;if(b.chartElement.data("fields"))b.chartElement.data("fields").seriesEles=null;b.chartElement.wijpie({canvas:b.canvas,tooltip:b.tooltip,bounds:d,radius:e,widgetName:b.widgetName,innerRadius:c.innerRadius,seriesList:c.seriesList,seriesStyles:c.seriesStyles,seriesHoverStyles:c.seriesHoverStyles,seriesTransition:c.seriesTransition,showChartLabels:c.showChartLabels,disabled:c.disabled,textStyle:c.textStyle,chartLabelStyle:c.chartLabelStyle,shadow:c.shadow,animation:c.animation,mouseDown:a.proxy(b._mouseDown,b),mouseUp:a.proxy(b._mouseUp,b),mouseOver:a.proxy(b._mouseOver,b),mouseOut:a.proxy(b._mouseOut,b),mouseMove:a.proxy(b._mouseMove,b),click:a.proxy(b._click,b)})},_getTooltipText:function(e,d){var c=a(d.node),b,f;if(c.data("owner"))c=c.data("owner");b=c.data("wijchartDataObj");f={data:b,value:b.value,label:b.label,total:b.total,target:d,fmt:e};return a.proxy(e,f)()}})})(jQuery);(function(a){"use strict";a.fn.extend({wijpie:function(b){var A=function(c,d,e){b.shadow&&a.wijchart.paintShadow(c,d,e)},z=a.wijchart.getDiffAttrs,u=a.wijraphael.addClass,q=a.wijraphael.getPositionByAngle,c=this,L=b.bounds,h=b.widgetName,i=b.canvas,e=b.animation,E=b.seriesList,S=b.seriesStyles,N=b.seriesHoverStyles,m=b.radius,o=b.innerRadius,k=b.seriesTransition,Q=b.showChartLabels,P=b.chartLabelStyle,l=b.disabled,F=b.mouseDown,J=b.mouseUp,H=b.mouseOver,I=b.mouseOut,G=b.mouseMove,M=b.click,K=b.tooltip,d=c.data("fields")||{},n=d.chartElements||{},r=d.aniSectorAttrs,s=d.aniLabelAttrs,B=[],C=[],w=[],f=[],t=[],j=0,x=0,T=L.startX,U=L.startY,D=[],y,g,p,v=i.set();function R(){var b={x:0,y:0},d=a.isFunction;K&&K.setTargets(t);a(".wijpiechart",c[0]).live("mousedown."+h,function(f){if(l)return;var b=a(f.target),e;if(b.data("owner"))b=b.data("owner");e=b.data("wijchartDataObj");if(!e)return;d(F)&&F.call(c,f,e)}).live("mouseup."+h,function(f){if(l)return;var b=a(f.target),e;if(b.data("owner"))b=b.data("owner");e=b.data("wijchartDataObj");if(!e)return;d(J)&&J.call(c,f,e)}).live("mouseover."+h,function(o){if(l)return;var k=a(o.target),h,n,p=e&&e.enabled,m,f,g,i,j;if(k.data("owner"))k=k.data("owner");h=k.data("wijchartDataObj");if(!h)return;n=h.pieID||"";m=h.index;f=c.data("fields").chartElements["sectors"+n][m];g=f.showAnimationTimer;i=f.hideAnimationTimer;j=f.explodeAnimationShowing;d(H)&&H.call(c,o,h);if(f.removed)return;f.wijAttr(h.hoverStyle);if(p){if(i){window.clearTimeout(i);i=null;f.hideAnimationTimer=i}if(g){window.clearTimeout(g);g=null;f.showAnimationTimer=null}if(j)return;g=window.setTimeout(function(){var a=e.duration,c=e.easing;if(f.removed)return;b=f.getOffset(e.offset||10);f.offset=b;f.shadow&&!f.shadow.removed&&f.shadow.hide();f.wijAnimate({transform:Raphael.format("t{0},{1}",b.x,b.y)},a,c);f.tracker&&!f.tracker.removed&&f.tracker.wijAnimate({transform:Raphael.format("t{0},{1}",b.x,b.y)},a,c);j=true;f.explodeAnimationShowing=j},150);f.showAnimationTimer=g}}).live("mouseout."+h,function(o){if(l)return;var k=a(o.target),g,n,p=e&&e.enabled,m,f,i,h,j;if(k.data("owner"))k=k.data("owner");g=k.data("wijchartDataObj");if(!g)return;n=g.pieID||"";m=g.index;f=c.data("fields").chartElements["sectors"+n][m];i=f.showAnimationTimer;h=f.hideAnimationTimer;j=f.explodeAnimationShowing;d(I)&&I.call(c,o,g);if(f.removed)return;if(g.style.segment)delete g.style.segment;f.wijAttr(g.style);if(p){if(h){window.clearTimeout(h);h=null;f.hideAnimationTimer=h}if(i){window.clearTimeout(i);i=null;f.showAnimationTimer=i}if(!j)return;h=window.setTimeout(function(){var a=e.duration,c=e.easing;b=f.offset;f.shadow&&!f.shadow.removed&&f.shadow.show();!f.removed&&f.wijAnimate({transform:"t0,0"},a,c);f.tracker&&!f.tracker.removed&&f.tracker.wijAnimate({transform:"t0,0"},a,c);f.shadow&&!f.shadow.removed&&f.shadow.wijAnimate({transform:"t0,0"},a,c);b={x:0,y:0};j=false;f.explodeAnimationShowing=j},150);f.hideAnimationTimer=h}}).live("mousemove."+h,function(f){if(l)return;var b=a(f.target),e;if(b.data("owner"))b=b.data("owner");e=b.data("wijchartDataObj");if(!e)return;d(G)&&G.call(c,f,e)}).live("click."+h,function(f){if(l)return;var b=a(f.target),e;if(b.data("owner"))b=b.data("owner");e=b.data("wijchartDataObj");if(!e)return;d(M)&&M.call(c,f,e)})}function O(){a(".wijpiechart",c[0]).die(h).die("."+h)}i.customAttributes.segment=function(h,i,d,b,g,f){var e=null,c=.01;if(b-d>360-c)b-=c;else if(b-d<c)b+=c;if(f)e=a.wijchart.donut(h,i,g,f,d,b);else e=a.wijchart.sector(h,i,g,d,b);return{path:e}};a.each(E,function(b,a){if(a&&typeof a.data==="number")x+=a.data});a.each(E,function(d,c){var n=a.extend({opacity:1,stroke:"gray","stroke-width":1},S[d]),H=360*c.data/x,E=T+m,F=U+m,I,b,l,G,e,h;p=c.pieID;c=a.extend(true,{offset:0},c);if(c.offset){I=q(E,F,c.offset,j+H/2);E=I.x;F=I.y}y=[E,F,j,j+H,m,o].concat(" ");if(r&&k.enabled){n.segment=y;if(d<r.length)g=r[d];else{g=a.extend(true,{},n);g.segment=[E,F,0,360,m,o].concat(" ")}b=i.path().attr(g);n=z(g,n);!b.removed&&b.wijAnimate(n,k.duration,k.easing,function(){A(b);h&&!h.removed&&!b.removed&&h.attr({path:b.attr("path")});delete n.segment})}else{b=i.path().attr({segment:y});A(b);b.wijAttr(n)}b.angles={start:j,end:j+H};b.getOffset=function(c){var a=q(E,F,c,(b.angles.start+b.angles.end)/2);return{x:a.x-E,y:a.y-F}};b.center={x:E,y:F};b.radius=m;if(o)b.innerRadius=o;h=b.clone();if(a.browser.msie&&a.browser.version<9)h.attr({opacity:.01,fill:"white","stroke-width":0,"fill-opacity":.01});else h.attr({opacity:.01,fill:"white","fill-opacity":.01});u(a(h.node),"wijchart-canvas-object wijpiechart pietracker wijchart-tracker"+d);a(h.node).data("owner",a(b.node));b.tracker=h;v.push(h);u(a(b.node),"wijchart-canvas-object wijpiechart wijmo-wijpiechart-series-"+d);a(b.node).data("wijchartDataObj",c);if(Q){G=q(E,F,c.offset+m*2/3,j+H/2);e=a.extend(true,{},e,P);if(c.textStyle)e=a.extend(true,e,c.textStyle);if(s&&k.enabled)if(d<s.length){g=s[d];g.text=c.label;l=i.text(0,0,"").attr(g);e=z(g,e);e.x=G.x;e.y=G.y;l.wijAnimate(e,k.duration,k.easing)}else l=i.text(G.x,G.y,c.label).attr(e);else l=i.text(G.x,G.y,c.label).attr(e);u(a(l.node),"wijchart-canvas-object wijpiechart");a(l.node).data("wijchartDataObj",c);t.push(l);f.push(l);C[d]=l.attr()}D.push({label:f[d],sector:b});if(c.visible===false){b.hide();f[d]&&f[d].hide();b.shadow&&b.shadow.hide();h.hide()}B[d]=b.attr();w.push(b);t.push(b);c.style=n;c.hoverStyle=N[d];c.index=d;c.value=c.data;c.y=c.data;c.total=x;c.type="pie";j+=H});f&&f.length&&a.each(f,function(b,a){a.toFront()});n.sectors=w;if(p){n["sectors"+p]=w;n["labels"+p]=f}n.labels=f;if(!d.chartElements)d.chartElements={};v.toFront();a.extend(true,d.chartElements,n);d.aniSectorAttrs=B;d.aniLabelAttrs=C;d.seriesEles=D;d.trackers=v;c.data("fields",d);O();R()}})})(jQuery);